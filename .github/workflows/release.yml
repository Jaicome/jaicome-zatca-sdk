name: Release

# Triggers on every push to main
# - If changesets exist: Creates/updates Release PR
# - If Release PR merged: Publishes to npm with OIDC provenance
on:
  push:
    branches:
      - main

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  id-token: write # Required for npm provenance

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for changesets to read git history

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build packages
        run: bun run --cwd packages/zatca-core build && bun run --cwd packages/zatca-server build

      - name: Run tests
        run: bun run --cwd packages/zatca-server test

      # Changesets action handles two scenarios:
      # 1. Changesets present â†’ Create/update Release PR with version bumps
      # 2. No changesets (Release PR was merged) â†’ Prepare for publishing
      - name: Version packages and create Release PR
        uses: changesets/action@v1
        id: changesets
        with:
          version: pnpm changeset version
          title: "release: version packages"
          commit: "release: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Verify that package.json versions actually changed
      # Prevents publishing on regular commits (only publish when Release PR merged)
      - name: Detect version changes
        id: version_check
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: |
          if git diff HEAD~1 HEAD --name-only | grep -q 'packages/.*/package.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Package versions changed - will publish to npm" >> $GITHUB_STEP_SUMMARY
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No version changes - skipping publish" >> $GITHUB_STEP_SUMMARY
          fi

      # Publishing steps only execute when BOTH conditions are met:
      # 1. No changesets present (Release PR was merged)
      # 2. Package versions changed in this commit
      - name: Pack @jaicome/zatca-core
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.version_check.outputs.changed == 'true'
        run: pnpm --filter @jaicome/zatca-core pack --pack-destination /tmp/publish

      - name: Pack @jaicome/zatca-server
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.version_check.outputs.changed == 'true'
        run: pnpm --filter @jaicome/zatca-server pack --pack-destination /tmp/publish

      - name: Publish @jaicome/zatca-core to npm
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.version_check.outputs.changed == 'true'
        run: |
          echo "ðŸ“¦ Publishing @jaicome/zatca-core..." >> $GITHUB_STEP_SUMMARY
          npm publish /tmp/publish/jaicome-zatca-core-*.tgz --access public --provenance
          echo "âœ… Published @jaicome/zatca-core" >> $GITHUB_STEP_SUMMARY

      - name: Publish @jaicome/zatca-server to npm
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.version_check.outputs.changed == 'true'
        run: |
          echo "ðŸ“¦ Publishing @jaicome/zatca-server..." >> $GITHUB_STEP_SUMMARY
          npm publish /tmp/publish/jaicome-zatca-server-*.tgz --access public --provenance
          echo "âœ… Published @jaicome/zatca-server" >> $GITHUB_STEP_SUMMARY
